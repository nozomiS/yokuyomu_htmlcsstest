<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¡Œæ•°ãƒ™ãƒ¼ã‚¹ç¸¦æ›¸ããƒšãƒ¼ã‚¸åˆ†å‰²</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded" />
    <style>
        /* ä¸Šéƒ¨ãƒãƒ¼ */
        #top-bar {
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 54px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #fafafa;
            box-shadow: 0 2px 8px rgba(0,0,0,0.10);
            z-index: 1001;
            padding: 0 16px;
            transition: transform 0.2s;
        }
        #top-bar.hidden {
            transform: translateY(-100%);
            pointer-events: none;
            opacity: 0;
        }
        #top-bar .material-symbols-outlined, #top-bar .material-symbols-rounded {
            font-size: 2em;
            cursor: pointer;
            user-select: none;
        }
        #top-bar-title {
            flex: 1 1 auto;
            text-align: center;
            font-size: 1.1em;
            font-weight: bold;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin: 0 16px;
        }
    .material-symbols-outlined {
      font-variation-settings:
      'FILL' 0,
      'wght' 400,
      'GRAD' 0,
      'opsz' 24
    }
    </style>
    <style>
        html, body {
            margin: 0; padding: 0; height: 100%; width: 100%;
            font-family: 'Noto Sans JP', 'Yu Gothic', 'Meiryo', sans-serif; font-size: 16px; line-height: 1.8;
            font-feature-settings: "lnum" 1, "pnum" 1;
            letter-spacing: 0.05em; color: #333; display: flex;
        }

        /* æœ¬æ–‡ï¼ˆç¸¦æ›¸ããƒšãƒ¼ã‚¸ï¼‰ã‚’æºãƒæ˜æœã§ */
        .page, .page .content, .page p, .page h3 {
            font-family: 'Source Han Serif JP', 'Noto Serif JP', 'Yu Mincho', 'Hiragino Mincho ProN', 'MS PMincho', serif;
        }
        /* h2è¦‹å‡ºã—ã¯ã‚´ã‚·ãƒƒã‚¯ä½“ã§å¼·èª¿ */
        .page h2 {
            font-family: 'Noto Sans JP', 'Yu Gothic', 'Meiryo', sans-serif !important;
            font-weight: bold;
            font-size: 1.7em;
            letter-spacing: 0.08em;
        }

        /* Google Fonts: æºãƒæ˜æœï¼ˆSource Han Serif JPï¼‰ã‚’èª­ã¿è¾¼ã¿ */
        @import url('https://fonts.googleapis.com/css2?family=Source+Han+Serif+JP:wght@400;700&display=swap');
        
        /* --- æ˜¼ãƒ¢ãƒ¼ãƒ‰ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰ --- */
        body,
        #viewer,
        .page,
        #book,
        .control-bar,
        #bottom-bar {
            background: #f5ede3;
            color: #3a3632;
        }
        .material-btn {
            background: #ede5d7;
            color: #3a3632;
        }
        #debug-panel {
            background: #f5f5f5;
            color: #333;
        }

        /* --- å¤œãƒ¢ãƒ¼ãƒ‰ --- */
        body.night-mode,
        body.night-mode #viewer,
        body.night-mode .page,
        body.night-mode #book,
        body.night-mode .control-bar,
        body.night-mode #bottom-bar {
            background: #444542;
            color: #e7e5e1;
        }
        body.night-mode .material-btn {
            background: #575753;
            color: #e7e5e1;
        }
        body.night-mode #debug-panel {
            background: #333;
            color: #e7e5e1;
        }
        
        #debug-panel {
            width: 300px; height: 100vh; overflow-y: auto;
            background-color: #f5f5f5; border-right: 2px solid #ccc;
            padding: 10px;
        }
        
        #debug-info {
            background: white; border: 1px solid #ddd; border-radius: 5px;
            padding: 8px; margin-bottom: 10px; font-family: monospace; font-size: 11px;
        }
        
        #step-controls button {
            margin-right: 5px; padding: 6px 10px;
            border: 1px solid #ccc; border-radius: 4px; cursor: pointer; font-size: 11px;
        }
        
        #debug-log {
            background: white; border: 1px solid #ddd; border-radius: 5px;
            padding: 8px; height: 250px; overflow-y: auto; font-family: monospace; font-size: 10px;
        }
        
        #copy-log-btn {
            margin-top: 5px; padding: 4px 8px;
            border: 1px solid #ccc; border-radius: 4px; cursor: pointer; font-size: 10px;
            background: #fff;
        }
        
        #viewer-container {
            flex: 1; display: flex; flex-direction: column;
            justify-content: center; align-items: center; padding: 20px;
        }
        
        #viewer {
            width: 70vw; height: 70vh; max-width: 500px;
            border: 1px solid #ccc;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); position: relative; overflow: hidden;
        }
        #bottom-bar, .control-bar {
            position: absolute; /* â˜…fixedâ†’absoluteã«å¤‰æ›´ */
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #fafafa;
            box-shadow: 0 -2px 8px rgba(0,0,0,0.18);
            padding: 10px 0;
            z-index: 1000;
            transition: transform 0.2s;
        }
        #book { 
            height: 100%; width: 100%; position: relative; 
        }
        
        .page {
            height: 100%; width: 100%; position: absolute; top: 0; left: 0;
            padding: 30px 20px; box-sizing: border-box;
            writing-mode: vertical-rl; text-orientation: mixed;
            overflow: hidden;
            visibility: hidden;
        }
        
        .page.visible {
            visibility: visible;
        }
        
        .content {
            width: auto; height: 100%; padding: 0;
            writing-mode: vertical-rl; text-orientation: mixed;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .page p { margin: 0; text-indent: 1em; }
        .page h2 {
            margin: 0; text-indent: 0;
            text-align: center; font-size: 1.5em; font-weight: bold;
        }
        .page h3 { margin: 0; text-indent: 0; }
        .page .no-indent-p { text-indent: 0; }
        
        #measure {
            position: absolute; top: -9999px; left: -9999px; visibility: hidden;
            font-family: 'Noto Sans JP', 'Yu Gothic', 'Meiryo', sans-serif; writing-mode: vertical-rl;
            text-orientation: mixed;
            font-feature-settings: "lnum" 1, "pnum" 1;
        }

        hr.section-separator {
            border: none;
            border-left: 2px solid #aaa;
            height: 80%;
            width: 0;
            margin: 0 16px;
            display: block;
            align-self: center;
        }

        /* ä¸‹éƒ¨ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒãƒ¼ */
        .control-bar {
            position: fixed;
            left: 0; right: 0; bottom: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #fff;
            box-shadow: 0 -2px 8px rgba(0,0,0,0.08);
            padding: 10px 0;
            z-index: 1000;
            transition: transform 0.2s;
        }
        .control-bar.hidden {
            transform: translateY(100%);
            pointer-events: none;
            opacity: 0;
        }
        .material-btn {
            background: #f5f5f5;
            border: none;
            border-radius: 50%;
            margin: 0 12px;
            width: 48px; height: 48px;
            font-size: 1.3em;
            color: #333;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
            transition: 0.2s;
        }
        .material-btn:active {
            background: #e0e0e0;
        }

        .hidden {
            display: none;
        }

    </style>
</head>
<body>

    <div id="viewer-container">
        <div id="viewer">
            <div id="top-bar" class="hidden">
                <span id="topbar-menu" class="material-symbols-outlined" title="ãƒ¡ãƒ‹ãƒ¥ãƒ¼">menu</span>
                <span id="top-bar-title">ã‚¿ã‚¤ãƒˆãƒ«</span>
                <span id="topbar-browser" class="material-symbols-outlined" title="ãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ã">open_in_browser</span>
            </div>
            <div id="book"></div>
            <div id="bottom-bar" class="control-bar hidden">
                <button id="font-smaller" class="material-btn" title="æ–‡å­—ã‚µã‚¤ã‚ºã‚’å°ã•ã">
                  <span class="material-symbols-outlined">text_decrease</span>
                </button>
                <button id="font-bigger" class="material-btn" title="æ–‡å­—ã‚µã‚¤ã‚ºã‚’å¤§ãã">
                  <span class="material-symbols-outlined" style="font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;">text_increase</span>
                </button>
                <button id="toggle-night" class="material-btn" title="ãƒŠã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿">
                  <span class="material-symbols-outlined">nights_stay</span>
                </button>
                <span id="page-indicator" style="margin-left:16px; font-size:1em;">
                    <span id="current-page-indicator">1</span> / <span id="total-page-indicator">1</span>
                </span>
            </div>
        </div>
    </div>
    <div id="source-content" style="display: none;">
        <h2>å¾è¼©ã¯çŒ«ã§ã‚ã‚‹</h2>
        <p>å¾è¼©ã¯çŒ«ã§ã‚ã‚‹ã€‚åå‰ã¯ã¾ã ç„¡ã„ã€‚</p>
        <p>ã©ã“ã§ç”Ÿã‚ŒãŸã‹ã¨ã‚“ã¨è¦‹å½“ãŒã¤ã‹ã¬ã€‚ä½•ã§ã‚‚è–„æš—ã„ã˜ã‚ã˜ã‚ã—ãŸæ‰€ã§ãƒ‹ãƒ£ãƒ¼ãƒ‹ãƒ£ãƒ¼æ³£ã„ã¦ã„ãŸäº‹ã ã‘ã¯è¨˜æ†¶ã—ã¦ã„ã‚‹ã€‚å¾è¼©ã¯ã“ã“ã§å§‹ã‚ã¦äººé–“ã¨ã„ã†ã‚‚ã®ã‚’è¦‹ãŸã€‚ã—ã‹ã‚‚ã‚ã¨ã§èãã¨ãã‚Œã¯æ›¸ç”Ÿã¨ã„ã†äººé–“ä¸­ã§ä¸€ç•ªç°æ‚ªãªç¨®æ—ã§ã‚ã£ãŸãã†ã ã€‚ã“ã®æ›¸ç”Ÿã¨ã„ã†ã®ã¯æ™‚ã€…æˆ‘ã€…ã‚’æ•ãˆã¦ç…®ã¦é£Ÿã†ã¨ã„ã†è©±ã§ã‚ã‚‹ã€‚ã—ã‹ã—ãã®å½“æ™‚ã¯ä½•ã¨ã„ã†è€ƒã‚‚ãªã‹ã£ãŸã‹ã‚‰åˆ¥æ®µæã—ã„ã¨ã‚‚æ€ã‚ãªã‹ã£ãŸã€‚ãŸã å½¼ã®æŒã«è¼‰ã›ã‚‰ã‚Œã¦ã‚¹ãƒ¼ã¨æŒã¡ä¸Šã’ã‚‰ã‚ŒãŸæ™‚ä½•ã ã‹ãƒ•ãƒ¯ãƒ•ãƒ¯ã—ãŸæ„Ÿã˜ãŒã‚ã£ãŸã°ã‹ã‚Šã§ã‚ã‚‹ã€‚æŒã®ä¸Šã§å°‘ã—è½ã¡ã¤ã„ã¦æ›¸ç”Ÿã®é¡”ã‚’è¦‹ãŸã®ãŒã„ã‚ã‚†ã‚‹äººé–“ã¨ã„ã†ã‚‚ã®ã®è¦‹å§‹ã§ã‚ã‚ã†ã€‚ã“ã®æ™‚å¦™ãªã‚‚ã®ã ã¨æ€ã£ãŸæ„Ÿã˜ãŒä»Šã§ã‚‚æ®‹ã£ã¦ã„ã‚‹ã€‚ç¬¬ä¸€æ¯›ã‚’ã‚‚ã£ã¦è£…é£¾ã•ã‚Œã¹ãã¯ãšã®é¡”ãŒã¤ã‚‹ã¤ã‚‹ã—ã¦ã¾ã‚‹ã§è–¬ç¼¶ã ã€‚ãã®å¾ŒçŒ«ã«ã‚‚ã ã„ã¶é€¢ã£ãŸãŒã“ã‚“ãªç‰‡è¼ªã«ã¯ä¸€åº¦ã‚‚å‡ºä¼šã‚ã—ãŸäº‹ãŒãªã„ã€‚ã®ã¿ãªã‚‰ãšé¡”ã®çœŸä¸­ãŒä½™ã‚Šã«çªèµ·ã—ã¦ã„ã‚‹ã€‚</p>
        <p>ãã†ã—ã¦ãã®ç©´ã®ä¸­ã‹ã‚‰æ™‚ã€…ã·ã†ã·ã†ã¨ç…™ã‚’å¹ãã€‚ã©ã†ã‚‚å’½ã›ã½ãã¦å®Ÿã«å¼±ã£ãŸã€‚ã“ã‚ŒãŒäººé–“ã®é£²ã‚€ç…™è‰ã¨ã„ã†ã‚‚ã®ã§ã‚ã‚‹äº‹ã¯ã‚ˆã†ã‚„ãã“ã®é ƒçŸ¥ã£ãŸã€‚</p>
        <p>è¡Œæ•°èª¿æ•´ã®è¡Œã§ã™ã€‚</p>
        <p>ã•ã‚‰ã«ç¶šãã®æ®µè½ã§ã™ã€‚ã“ã‚Œã¯æ–°ã—ã„æ®µè½ã¨ã—ã¦è¡¨ç¤ºã•ã‚Œã‚‹ã¯ãšã§ã™ã€‚ã“ã®æ®µè½ã‚‚ã€ãƒšãƒ¼ã‚¸å…ˆé ­ã§ãªã‘ã‚Œã°è¡Œé ­ãŒå­—ä¸‹ã’ã•ã‚Œã¾ã™ã€‚é•·ã„æ–‡ç« ã«ãªã‚‹ã‚ˆã†ã«æ–‡å­—æ•°ã‚’å¢—ã‚„ã—ã¦ã€è¤‡æ•°è¡Œã«ã‚ãŸã‚‹æ®µè½ã®å‡¦ç†ã‚’ãƒ†ã‚¹ãƒˆã—ã¾ã™ã€‚ç¸¦æ›¸ãã§ã®æ”¹è¡Œå‹•ä½œãŒæ­£ã—ãæ¤œå‡ºã•ã‚Œã€ãƒšãƒ¼ã‚¸åˆ†å‰²ã®ãƒ­ã‚¸ãƒƒã‚¯ãŒæœŸå¾…é€šã‚Šã«å‹•ä½œã™ã‚‹ã“ã¨ã‚’ç¢ºèªã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚</p>
        <p>çŸ­ã‚ã®æ®µè½ã‚‚ã„ãã¤ã‹è¿½åŠ ã—ã¦ã¿ã¾ã™ã€‚</p>
        <p>ã“ã‚Œã§ã©ã†ã§ã—ã‚‡ã†ã‹ã€‚</p>
        <h3>æ–°ã—ã„ç« ã®é–‹å§‹</h3>
        <p>ã“ã“ã‹ã‚‰æ–°ã—ã„ç« ãŒå§‹ã¾ã‚‹å ´åˆã‚’æƒ³å®šã—ã¦ã„ã¾ã™ã€‚ã“ã®æ®µè½ã‚‚ã€ãƒšãƒ¼ã‚¸ã®é€”ä¸­ã§é–‹å§‹ã—ãŸå ´åˆã¯å­—ä¸‹ã’ã•ã‚Œã¾ã™ãŒã€ãƒšãƒ¼ã‚¸å…ˆé ­ã«æ¥ãŸå ´åˆã¯å­—ä¸‹ã’ã•ã‚Œã¾ã›ã‚“ã€‚è¦‹å‡ºã—ã®å¾Œã®æ®µè½ã¯é©åˆ‡ã«å‡¦ç†ã•ã‚Œã‚‹ã§ã—ã‚‡ã†ã‹ã€‚é•·ã‚ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’ç”¨æ„ã—ã¦ã€è¤‡æ•°è¡Œã«ã‚ãŸã‚‹è¡¨ç¤ºã‚’ãƒ†ã‚¹ãƒˆã—ã¾ã™ã€‚</p>
        <p>é•·ã„æ®µè½ã®ç¶šãã®ãƒ†ã‚­ã‚¹ãƒˆã§ã™ã€‚ã“ã®ãƒ†ã‚­ã‚¹ãƒˆãŒãƒšãƒ¼ã‚¸ã‚’ã¾ãŸãã¨ã€æ¬¡ã®ãƒšãƒ¼ã‚¸ã®å…ˆé ­ã«æ¥ãŸéš›ã«å­—ä¸‹ã’ã•ã‚Œãªã„ã‚ˆã†ã«å‡¦ç†ã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€èª­æ›¸ä½“é¨“ãŒã‚ˆã‚Šè‡ªç„¶ã«ãªã‚Šã¾ã™ã€‚ç¸¦æ›¸ããƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã§ã®æ”¹è¡Œæ¤œå‡ºã¨ãƒšãƒ¼ã‚¸åˆ†å‰²ãŒæ­£ç¢ºã«å‹•ä½œã—ã€å®Ÿç”¨çš„ãªãƒ“ãƒ¥ãƒ¼ãƒ¯ãƒ¼ã‚’ä½œæˆã§ãã‚‹ã“ã¨ã‚’ç›®æŒ‡ã—ã¦ã„ã¾ã™ã€‚æ–‡å­—æ•°ã‚’ã•ã‚‰ã«å¢—ã‚„ã—ã¦ã€ã‚ˆã‚Šå¤šãã®è¡Œæ•°ã§ã®å‹•ä½œç¢ºèªã‚’è¡Œã„ã¾ã™ã€‚</p>
    </div>

    <div id="debug-panel">
        <h3>ãƒ‡ãƒãƒƒã‚°æƒ…å ±</h3>
        <div id="debug-info">
            <div>æœ€å¤§è¡Œæ•°: <span id="max-lines">-</span>è¡Œ</div>
            <div>ç¾åœ¨è¡Œæ•°: <span id="current-lines">-</span>è¡Œ</div>
            <div>ç¾åœ¨ãƒšãƒ¼ã‚¸: <span id="current-page">1</span> / <span id="total-pages">1</div>
            <div>å‡¦ç†ä¸­: <span id="current-element">-</span></div>
        </div>
        
        <div id="step-controls">E
            <button id="step-btn">1ã‚¹ãƒ†ãƒƒãƒ—å®Ÿè¡Œ</button>
            <button id="reset-btn">ãƒªã‚»ãƒƒãƒˆ</button>
            <button id="prev-page-btn">â—€ å‰ãƒšãƒ¼ã‚¸</button>
            <button id="next-page-btn">æ¬¡ãƒšãƒ¼ã‚¸ â–¶</button>
        </div>
        
        <!-- â–¼ã“ã“ã‹ã‚‰è¿½åŠ  -->
        <div style="margin:10px 0;">
            <input type="file" id="fileInput" accept=".html">
            <input type="text" id="selectorInput" placeholder="ä¾‹: .js-novel-text" style="width:120px;">
            <button id="loadHtmlBtn">å¤–éƒ¨HTMLèª­è¾¼</button>
        </div>
        <!-- â–²ã“ã“ã¾ã§è¿½åŠ  -->

        <div id="debug-log"></div>
        <button id="copy-log-btn">ãƒ­ã‚°ã‚’ã‚³ãƒ”ãƒ¼</button>
    </div>

    <!-- viewer-container/viewer/top-bar/book/bottom-bar are now grouped together above -->

    <script>
// åŠè§’è‹±æ•°å­—ã‚’å…¨è§’ã«å¤‰æ›ã™ã‚‹é–¢æ•°
function toZenkaku(str) {
    return str.replace(/[A-Za-z0-9]/g, function(s) {
        return String.fromCharCode(s.charCodeAt(0) + 0xFEE0);
    });
}

    class LineCountDebug {
        title = '';
        constructor() {
            this.viewer = document.getElementById('viewer');
            this.book = document.getElementById('book');
            this.debugLog = document.getElementById('debug-log');
            this.source = document.getElementById('source-content');

            this.topBar = document.getElementById('top-bar');
            this.topBarTitle = document.getElementById('top-bar-title');
            
            // å®‰å…¨ã«DOMè¦ç´ ã‚’å–å¾—
            this.maxLinesSpan = document.getElementById('max-lines');
            this.currentLinesSpan = document.getElementById('current-lines');
            this.currentElementSpan = document.getElementById('current-element');
            this.currentPageSpan = document.getElementById('current-page');
            this.totalPagesSpan = document.getElementById('total-pages');
            
            this.maxAllowedLines = 0;
            this.currentLineCount = 1;
            
            // ãƒšãƒ¼ã‚¸ç®¡ç†
            this.pages = []; // å„ãƒšãƒ¼ã‚¸ã®HTMLå†…å®¹
            this.pageMeta = []; // å„ãƒšãƒ¼ã‚¸ã®{startId, endId}
            this.currentPageIndex = 0;
            
            // å…ƒã®HTMLã‹ã‚‰æ®µè½ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡º
            this.paragraphs = [];
            this.currentParagraphIndex = 0;
            this.currentParagraphContent = ''; // ç¾åœ¨ã®æ®µè½ã®å†…å®¹ã®ã¿
            this.completedParagraphs = []; // å®Œäº†ã—ãŸæ®µè½ã®HTML
            this.totalLineCount = 1; // ãƒšãƒ¼ã‚¸å…¨ä½“ã§ã®ç´¯ç©è¡Œæ•°
            
            this.currentParagraphHasIndent = true; // â†è¿½åŠ 
            
            this.init();
        }

        init() {
            // å…ƒã®HTMLã‹ã‚‰æ®µè½ã‚’æŠ½å‡º
            this.extractParagraphs();
            // DOMè¦ç´ ã®ã‚µã‚¤ã‚ºãŒç¢ºå®šã™ã‚‹ã¾ã§å°‘ã—å¾…ã¤
            setTimeout(() => {
                this.setupMeasure();
                this.initEventListeners();
                this.log('åˆæœŸåŒ–å®Œäº†');
            }, 100);
        }

        extractParagraphsFromPayLoad(payload) {
            this.paragraphs = [];
            const elements = Array.from(payload);
            let foundTitle = '';
            elements.forEach(element => {
                if (element.tagName === 'H2' || element.tagName === 'H3') {
                    // h2/h3ã®ãƒ†ã‚­ã‚¹ãƒˆæŠ½å‡ºã‚’å¼·åŒ–
                    let headingText = '';
                    // 1. textContent
                    if (element.textContent && element.textContent.trim() !== '') {
                        headingText = element.textContent.trim();
                    } else if (element.innerText && element.innerText.trim() !== '') {
                        // 2. innerText
                        headingText = element.innerText.trim();
                    } else if (element.innerHTML && element.innerHTML.replace(/<[^>]+>/g, '').trim() !== '') {
                        // 3. innerHTML (strip tags)
                        headingText = element.innerHTML.replace(/<[^>]+>/g, '').trim();
                    } else if (element.className && element.className.trim() !== '') {
                        // 4. className fallback
                        headingText = element.className;
                    } else {
                        // 5. default
                        headingText = 'ã‚¿ã‚¤ãƒˆãƒ«ãªã—';
                    }
                    // æ—¢ã«å…¨è§’åŒ–ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯å†å¤‰æ›ã—ãªã„
                    // åŠè§’è‹±æ•°å­—ãŒå«ã¾ã‚Œã¦ã„ã‚Œã°toZenkaku
                    const zenkakuHeading = /[A-Za-z0-9]/.test(headingText) ? toZenkaku(headingText) : headingText;
                    this.paragraphs.push({
                        type: 'heading',
                        tag: element.tagName.toLowerCase(),
                        content: zenkakuHeading,
                        hasIndent: false
                    });
                    // æœ€åˆã®h2ã‚’ã‚¿ã‚¤ãƒˆãƒ«ã¨ã—ã¦è¨˜æ†¶
                    if (!foundTitle && element.tagName === 'H2' && zenkakuHeading) {
                        foundTitle = zenkakuHeading;
                    }
                } else if (element.tagName === 'P') {
                    // <p><br></p> ã®ã‚ˆã†ãªç©ºè¡Œã‚’æ¤œå‡º
                    const isEmptyLine =
                        (element.childNodes.length === 1 && element.childNodes[0].tagName === 'BR') ||
                        (element.innerHTML.trim() === '<br>' || element.innerHTML.trim() === '' || element.textContent.replace(/[\s\u3000]/g, '') === '');
                    let pid = element.getAttribute && element.getAttribute('id') ? element.getAttribute('id') : null;
                    if (isEmptyLine) {
                        this.paragraphs.push({
                            type: 'paragraph',
                            tag: 'p',
                            content: '',
                            hasIndent: false, // ç©ºè¡Œã¯å­—ä¸‹ã’ãªã—
                            isEmpty: true,
                            id: pid
                        });
                    } else {
                        // å…ˆé ­ã®å­—ä¸‹ã’æ–‡å­—ï¼ˆå…¨è§’ãƒ»åŠè§’ã‚¹ãƒšãƒ¼ã‚¹ãƒ»ã‚¿ãƒ–ç­‰ï¼‰ã‚’1æ–‡å­—å‰Šé™¤
                        let text = element.textContent.replace(/^[ \u3000\t]/, "");
                        this.paragraphs.push({
                            type: 'paragraph',
                            tag: 'p',
                            content: toZenkaku(text),
                            hasIndent: true,
                            isEmpty: false,
                            id: pid
                        });
                    }
                } else if (element.tagName === 'HR' && element.classList.contains('section-separator')) {
                    this.paragraphs.push({
                        type: 'separator',
                        tag: 'hr',
                        content: '',
                        hasIndent: false
                    });
                }
            });
            // ã‚¿ã‚¤ãƒˆãƒ«ã‚»ãƒƒãƒˆ
            this.title = foundTitle || '';
            if (this.topBarTitle) {
                this.topBarTitle.textContent = this.title || 'ã‚¿ã‚¤ãƒˆãƒ«';
            }
            this.log(`æ®µè½æŠ½å‡ºå®Œäº†: ${this.paragraphs.length}å€‹ã®æ®µè½`);
            this.paragraphs.forEach((para, i) => {
                this.log(`${i + 1}: ${para.type} \"${para.content ? para.content.substring(0, 20) : ''}...\"`);
            });

        }

        extractParagraphs() {
            this.extractParagraphsFromPayLoad(this.source.children);
        }

        setupMeasure() {
            try {
                const viewerStyle = window.getComputedStyle(this.viewer);
                const fontSize = parseFloat(viewerStyle.fontSize);
                const lineHeightValue = viewerStyle.lineHeight;
                const lineHeightPx = parseFloat(lineHeightValue);
                
                // ã‚µã‚¤ã‚ºãŒ0ã®å ´åˆã¯ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å€¤ã‚’ä½¿ç”¨
                const viewerWidth = this.viewer.clientWidth || 500;
                const viewerHeight = this.viewer.clientHeight || 400;
                const contentWidth = Math.max(viewerWidth - 40, 200); // æœ€ä½200pxç¢ºä¿
                const contentHeight = Math.max(viewerHeight - 60, 200); // æœ€ä½200pxç¢ºä¿
                
                // æ¨ªå¹…ã‹ã‚‰æœ€å¤§è¡Œæ•°ã‚’è¨ˆç®—
                this.maxAllowedLines = Math.floor(contentWidth / lineHeightPx);
                
                if (this.maxLinesSpan) {
                    this.maxLinesSpan.textContent = this.maxAllowedLines;
                }
                
                this.log(`è¨ˆç®—å€¤: maxLines=${this.maxAllowedLines}è¡Œ`);
            } catch (error) {
                this.log(`ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }

        log(message) {
            const entry = document.createElement('div');
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            this.debugLog.appendChild(entry);
            this.debugLog.scrollTop = this.debugLog.scrollHeight;
        }

        copyLog() {
            const logText = Array.from(this.debugLog.children)
                .map(entry => entry.textContent)
                .join('\n');
            
            navigator.clipboard.writeText(logText).then(() => {
                this.log('ãƒ­ã‚°ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
            }).catch(err => {
                this.log('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err);
            });
        }

        displayCurrentContent(content) {
            this.book.innerHTML = `<div class='page visible'><div class="content">${content}</div></div>`;
        }

        addPage(content, startParaIdx, endParaIdx) {
            this.pages.push(content);
            // ãƒšãƒ¼ã‚¸å†…ã®æœ€åˆã¨æœ€å¾Œã®idï¼ˆp, heading, separatorã‚‚å«ã‚€ï¼‰ã‚’è¨˜éŒ²
            let startId = null, endId = null;
            for (let i = startParaIdx; i <= endParaIdx; i++) {
                const para = this.paragraphs[i];
                if (para && para.id) {
                    if (startId === null) startId = para.id;
                    endId = para.id;
                }
            }
            this.pageMeta.push({ startId, endId, startParaIdx, endParaIdx });
            this.log(`ãƒšãƒ¼ã‚¸${this.pages.length}ã‚’ä½œæˆã—ã¾ã—ãŸ (startId=${startId}, endId=${endId}, startParaIdx=${startParaIdx}, endParaIdx=${endParaIdx})`);

            // ãƒ‡ãƒãƒƒã‚°ç”¨: pageMetaã‚’è¡¨ç¤º
            this.displayPageMetaDebug();

            if (this.totalPagesSpan) {
                this.totalPagesSpan.textContent = this.pages.length;
            }
            // ãƒœãƒˆãƒ ãƒãƒ¼ã®ãƒˆãƒ¼ã‚¿ãƒ«ãƒšãƒ¼ã‚¸ã‚‚æ›´æ–°
            const totalPageIndicator = document.getElementById('total-page-indicator');
            if (totalPageIndicator) totalPageIndicator.textContent = this.pages.length.toString();
        }

        // ãƒ‡ãƒãƒƒã‚°ç”¨: pageMetaã‚’è¡¨ç¤º
        displayPageMetaDebug() {
            // ãƒ‡ãƒãƒƒã‚°ãƒ‘ãƒãƒ«å†…ã«è¡¨ç¤º
            let debugPanel = document.getElementById('debug-panel');
            if (!debugPanel) return;
            let debugDiv = document.getElementById('page-meta-debug');
            if (!debugDiv) {
                debugDiv = document.createElement('div');
                debugDiv.id = 'page-meta-debug';
                debugDiv.style.whiteSpace = 'pre';
                debugDiv.style.fontSize = '12px';
                debugDiv.style.background = '#f8f8f8';
                debugDiv.style.border = '1px solid #ccc';
                debugDiv.style.margin = '8px 0';
                debugDiv.style.padding = '4px';
                debugDiv.style.maxHeight = '120px';
                debugDiv.style.overflowY = 'auto';
                // debug-panelã®ä¸€ç•ªä¸‹ã«æŒ¿å…¥
                debugPanel.appendChild(debugDiv);
            }
            debugDiv.textContent = '[pageMeta debug]\n' + this.pageMeta.map((meta, i) => `Page ${i+1}: startId=${meta.startId}, endId=${meta.endId}, startParaIdx=${meta.startParaIdx}, endParaIdx=${meta.endParaIdx}`).join('\n');
        }
        displayCurrentPage() {
            if (this.pages.length === 0) {
                this.log('ãƒšãƒ¼ã‚¸ãŒã‚ã‚Šã¾ã›ã‚“');
                // ãƒšãƒ¼ã‚¸ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ã‚‚ãƒªã‚»ãƒƒãƒˆ
                const currentPageIndicator = document.getElementById('current-page-indicator');
                const totalPageIndicator = document.getElementById('total-page-indicator');
                if (currentPageIndicator) currentPageIndicator.textContent = '0';
                if (totalPageIndicator) totalPageIndicator.textContent = '0';
                return;
            }

            const content = this.pages[this.currentPageIndex];
            this.book.innerHTML = `<div class='page visible'><div class="content">${content}</div></div>`;

            if (this.currentPageSpan) {
                this.currentPageSpan.textContent = this.currentPageIndex + 1;
            }
            // ãƒœãƒˆãƒ ãƒãƒ¼ã®ç¾åœ¨ãƒšãƒ¼ã‚¸ã‚‚æ›´æ–°
            const currentPageIndicator = document.getElementById('current-page-indicator');
            if (currentPageIndicator) currentPageIndicator.textContent = (this.currentPageIndex + 1).toString();
        }

        nextPage() {
            if (this.currentPageIndex < this.pages.length - 1) {
                this.currentPageIndex++;
                this.displayCurrentPage();
                this.log(`æ¬¡ãƒšãƒ¼ã‚¸: ${this.currentPageIndex + 1}/${this.pages.length}`);
            }
        }

        prevPage() {
            if (this.currentPageIndex > 0) {
                this.currentPageIndex--;
                this.displayCurrentPage();
                this.log(`å‰ãƒšãƒ¼ã‚¸: ${this.currentPageIndex + 1}/${this.pages.length}`);
            }
        }

        setupSwipeEvents() {
            let startX = 0;
            let startY = 0;
            let isMouseDown = false;

            // ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆ
            this.viewer.addEventListener('touchstart', (e) => {
                startX = e.touches[0].clientX;
                startY = e.touches[0].clientY;
            });

            this.viewer.addEventListener('touchend', (e) => {
                const endX = e.changedTouches[0].clientX;
                const endY = e.changedTouches[0].clientY;
                const deltaX = endX - startX;
                const deltaY = endY - startY;
                if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > 50) {
                    if (deltaX > 0) {
                        this.prevPage();
                    } else {
                        this.nextPage();
                    }
                }
            });

            // ãƒã‚¦ã‚¹ã‚¤ãƒ™ãƒ³ãƒˆ
            this.viewer.addEventListener('mousedown', (e) => {
                isMouseDown = true;
                startX = e.clientX;
                startY = e.clientY;
            });

            this.viewer.addEventListener('mouseup', (e) => {
                if (!isMouseDown) return;
                isMouseDown = false;
                const endX = e.clientX;
                const endY = e.clientY;
                const deltaX = endX - startX;
                const deltaY = endY - startY;
                if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > 50) {
                    if (deltaX > 0) {
                        this.nextPage();
                    } else {
                        this.prevPage();
                    }
                }
            });
        }

        stepExecution() {
            this.log(`ğŸ” stepExecutioné–‹å§‹: paragraphIndex=${this.currentParagraphIndex}, content="${this.currentParagraphContent}"`);

            let lineWidth = 28.8;
            let parentContentWidth = 0;
            if (this.book.querySelector('.page')) {
                parentContentWidth = this.book.querySelector('.page').scrollWidth;
            } else {
                parentContentWidth = this.viewer.clientWidth - 40; // ä½™ç™½ã‚’å¼•ã„ãŸå¹…
            }

            // ãƒšãƒ¼ã‚¸ã®é–‹å§‹æ®µè½indexã‚’è¨˜éŒ²
            let pageStartParaIdx = this.currentParagraphIndex;

            while (true) {
                if (this.currentParagraphIndex >= this.paragraphs.length) {
                    // â˜…æœ€å¾Œã®ãƒšãƒ¼ã‚¸ãŒæœªè¿½åŠ ãªã‚‰è¿½åŠ 
                    const finalHTML = this.completedParagraphs.join('');
                    if (finalHTML && (this.pages.length === 0 || this.pages[this.pages.length - 1] !== finalHTML)) {
                        // ãƒšãƒ¼ã‚¸ã®é–‹å§‹ãƒ»çµ‚äº†æ®µè½indexã‚’è¨˜éŒ²
                        this.addPage(finalHTML, pageStartParaIdx, this.currentParagraphIndex - 1);
                    }
                    this.log('å…¨æ®µè½å‡¦ç†å®Œäº†');
                    break;
                }

                const currentPara = this.paragraphs[this.currentParagraphIndex];

                // ãƒšãƒ¼ã‚¸ã¾ãŸãæ™‚ã®ãƒãƒƒãƒ•ã‚¡
                if (!this._paragraphBuffer) {
                    this._paragraphBuffer = currentPara.content.substring(this.currentParagraphContent.length);
                }

                // ãƒšãƒ¼ã‚¸å…ˆé ­ã®å­—ä¸‹ã’åˆ¶å¾¡
                if (this.currentParagraphContent === '') {
                    if (this.completedParagraphs.length === 0 && this.pages.length > 0) {
                        this.currentParagraphHasIndent = false;
                    } else {
                        this.currentParagraphHasIndent = currentPara.hasIndent;
                    }
                }

                let lines = [];
                let pageFull = false;
                let startContentWidth = 0;

                // ç©ºè¡Œã‚„è¦‹å‡ºã—ãƒ»ã‚»ãƒ‘ãƒ¬ãƒ¼ã‚¿ã¯ä¸€ç™ºã§å‡¦ç†
                if (currentPara.type !== 'paragraph' || currentPara.isEmpty) {
                    // ãƒšãƒ¼ã‚¸å…ˆé ­ã§ç©ºè¡Œã®å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—ï¼ˆå‡ºåŠ›ã—ãªã„ï¼‰
                    if (currentPara.isEmpty && this.completedParagraphs.length === 0) {
                        this.log('ãƒšãƒ¼ã‚¸å…ˆé ­ã®ç©ºè¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—');
                        this.currentParagraphIndex++;
                        this.currentParagraphContent = '';
                        this._paragraphBuffer = null;
                        continue;
                    }
                    const finalHTML = this.generateHTML(
                        { ...currentPara, hasIndent: this.currentParagraphHasIndent },
                        this.currentParagraphContent
                    );
                    const finalAllHTML = this.completedParagraphs.join('') + finalHTML;
                    this.displayCurrentContent(finalAllHTML);
                    this.completedParagraphs.push(finalHTML);
                    this.currentParagraphIndex++;
                    this.currentParagraphContent = '';
                    this._paragraphBuffer = null;
                    continue;
                }

                while (this._paragraphBuffer.length > 0 && !pageFull) {
                    let line = '';
                    let prevWidth = 0;

                    let startContentWidth = 0;
                    if (this.book.querySelector('.content')) {
                        startContentWidth = this.book.querySelector('.content').scrollWidth;
                    }
                    let lastContentWidth = 0;

                    // 1æ–‡å­—ãšã¤è¿½åŠ ã—ã¦æ”¹è¡Œåˆ¤å®š
                    for (let i = 0; i < this._paragraphBuffer.length; i++) {
                        line += this._paragraphBuffer[i];

                        // ä»®HTMLç”Ÿæˆ
                        const currentHTML = this.generateHTML(
                            { ...currentPara, hasIndent: this.currentParagraphHasIndent },
                            this.currentParagraphContent + lines.join('') + line
                        );
                        const allHTML = this.completedParagraphs.join('') + currentHTML;
                        this.displayCurrentContent(allHTML);

                        lastContentWidth = this.book.querySelector('.content').scrollWidth;

                        // æ”¹è¡Œæ¤œå‡º
                        if (i > 0 && lastContentWidth > startContentWidth) {
                            // ã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼æ–‡å­—ã‚’ãƒãƒƒãƒ•ã‚¡ã«æˆ»ã™
                            line = line.slice(0, -1);
                            this._paragraphBuffer = this._paragraphBuffer.slice(i);
                            lineWidth = lastContentWidth - startContentWidth;
                            break;
                        }

                        if (i === 0) startContentWidth = lastContentWidth;

                        // ãƒãƒƒãƒ•ã‚¡ã‚’ä½¿ã„åˆ‡ã£ãŸå ´åˆ
                        if (i === this._paragraphBuffer.length - 1) {
                            this._paragraphBuffer = '';
                        }
                    }

                    if (line.length > 0) {
                        lines.push(line);
                    }

                    // ãƒšãƒ¼ã‚¸å†…å®¹ã‚’ä»®ç”Ÿæˆã—ã¦è¡Œæ•°åˆ¤å®š
                    const pageHTML = this.generateHTML(
                        { ...currentPara, hasIndent: this.currentParagraphHasIndent },
                        this.currentParagraphContent + lines.join('')
                    );
                    const allHTML = this.completedParagraphs.join('') + pageHTML;
                    this.displayCurrentContent(allHTML);

                    this.calculateCurrentLines();
                    if ((lastContentWidth + lineWidth * 2) >= parentContentWidth) {
                        pageFull = true;
                    }
                }

                // ãƒšãƒ¼ã‚¸ã«è¿½åŠ ã—ãŸåˆ†ã ã‘currentParagraphContentã‚’é€²ã‚ã‚‹
                this.currentParagraphContent += lines.join('');

                // ãƒšãƒ¼ã‚¸å†…å®¹ã‚’ç¢ºå®š
                const finalHTML = this.generateHTML(
                    { ...currentPara, hasIndent: this.currentParagraphHasIndent },
                    this.currentParagraphContent
                );
                const finalAllHTML = this.completedParagraphs.join('') + finalHTML;
                this.displayCurrentContent(finalAllHTML);

                // æ”¹ãƒšãƒ¼ã‚¸åˆ¤å®š
                if (pageFull) {
                    this.log(`ğŸš¨ æ”¹ãƒšãƒ¼ã‚¸å¿…è¦ï¼ ${this.totalLineCount}è¡Œ >= ${this.maxAllowedLines}è¡Œ`);
                    // ãƒšãƒ¼ã‚¸ã®é–‹å§‹ãƒ»çµ‚äº†æ®µè½indexã‚’è¨˜éŒ²
                    this.addPage(finalAllHTML, pageStartParaIdx, this.currentParagraphIndex);

                    // æ¬¡ãƒšãƒ¼ã‚¸ã®æº–å‚™
                    this.completedParagraphs = [];
                    this.totalLineCount = 1;
                    this.currentParagraphHasIndent = false; // â˜…åˆ†æ–­ãƒ‘ãƒ©ã‚°ãƒ©ãƒ•ã¯å­—ä¸‹ã’ãªã—

                    // currentParagraphContentã¯é€²ã‚ãŸçŠ¶æ…‹ã§
                    // _paragraphBufferã¯æ®‹ã‚Šã‚’ä¿æŒ
                    // ãŸã ã—ã€æ®µè½ãŒåˆ†æ–­ã•ã‚Œã¦ã„ãªã„å ´åˆã¯currentParagraphContentã‚’ãƒªã‚»ãƒƒãƒˆã—ã€æ¬¡ãƒšãƒ¼ã‚¸ã§é‡è¤‡ã—ãªã„ã‚ˆã†ã«ã™ã‚‹
                    if (!this._paragraphBuffer || this._paragraphBuffer.length === 0) {
                        // æ®µè½ãŒåˆ†æ–­ã•ã‚Œã¦ã„ãªã„ï¼ˆå…¨éƒ¨åã¾ã£ãŸï¼‰å ´åˆã¯æ¬¡ãƒšãƒ¼ã‚¸ã§é‡è¤‡ã—ãªã„ã‚ˆã†ã«é€²ã‚ã‚‹
                        this.currentParagraphIndex++;
                        this.currentParagraphContent = '';
                        this._paragraphBuffer = null;
                    } else {
                        // åˆ†æ–­ã•ã‚ŒãŸå ´åˆã¯currentParagraphContentã®ã¿ãƒªã‚»ãƒƒãƒˆ
                        this.currentParagraphContent = '';
                    }
                    // æ¬¡ãƒšãƒ¼ã‚¸ã®é–‹å§‹æ®µè½indexã‚’è¨˜éŒ²
                    pageStartParaIdx = this.currentParagraphIndex;
                    this.log(`ğŸ”„ æ”¹ãƒšãƒ¼ã‚¸å®Œäº†: ãƒãƒƒãƒ•ã‚¡æ®‹ã‚Š="${this._paragraphBuffer}"`);
                    continue; // â†å†å¸°ã®ä»£ã‚ã‚Šã«ãƒ«ãƒ¼ãƒ—ç¶™ç¶š
                }

                // æ®µè½çµ‚äº†
                if (!this._paragraphBuffer || this._paragraphBuffer.length === 0) {
                    this.completedParagraphs.push(finalHTML);
                    this.log(`æ®µè½${this.currentParagraphIndex + 1}å®Œäº†: ${finalHTML}`);

                    this.currentParagraphIndex++;
                    this.currentParagraphContent = '';
                    this._paragraphBuffer = null;
                    this.log(`ğŸ” æ®µè½å®Œäº†ã§ãƒªã‚»ãƒƒãƒˆ: paragraphIndex=${this.currentParagraphIndex}, content="${this.currentParagraphContent}"`);
                    continue; // â†å†å¸°ã®ä»£ã‚ã‚Šã«ãƒ«ãƒ¼ãƒ—ç¶™ç¶š
                }

                // 1è¡Œé€²ã‚ãŸã®ã§çµ‚äº†ï¼ˆæ¬¡ã®stepã§æ®‹ã‚Šã‚’å‡¦ç†ï¼‰
                break;
            }
        }

        calculateCurrentLines() {
            const pageElement = this.book.querySelector('.content');
            if (!pageElement) {
                this.totalLineCount = 1;
                return;
            }

            const allTextNodes = [];
            
            function collectTextNodes(node) {
                if (node.nodeType === Node.TEXT_NODE && node.textContent.trim() !== '') {
                    allTextNodes.push(node);
                } else {
                    for (let child of node.childNodes) {
                        collectTextNodes(child);
                    }
                }
            }
            collectTextNodes(pageElement);
            
            if (allTextNodes.length > 0) {
                const range = document.createRange();
                range.setStart(allTextNodes[0], 0);
                range.setEnd(allTextNodes[allTextNodes.length - 1], allTextNodes[allTextNodes.length - 1].textContent.length);
                const rangeRect = range.getBoundingClientRect();
                const rangeWidth = rangeRect.width;
                this.totalLineCount = Math.ceil(rangeWidth / 28.8);
                
                this.log(`è¡Œæ•°è¨ˆç®—: å¹…=${rangeWidth.toFixed(2)}px, è¡Œæ•°=${this.totalLineCount}è¡Œ`);
            } else {
                this.totalLineCount = 1;
            }
            
            if (this.currentLinesSpan) {
                this.currentLinesSpan.textContent = this.totalLineCount;
            }
        }

        generateHTML(paragraph, content) {
            if (paragraph.type === 'heading') {
                // headingã¯paragraph.contentã‚’å¸¸ã«ä½¿ã†ï¼ˆcurrentParagraphContentã¯ä½¿ã‚ãªã„ï¼‰
                const headingText = (!paragraph.content || paragraph.content.trim() === "") ? "&nbsp;" : paragraph.content;
                return `<${paragraph.tag}><span>${headingText}</span></${paragraph.tag}>`;
            } else if (paragraph.type === 'separator') {
                return `<hr class="section-separator">`;
            } else if (paragraph.isEmpty) {
                // ç©ºè¡Œã¯ <p class="empty-line"><br></p> ã§å‡ºåŠ›
                return `<p class="empty-line"><br></p>`;
            } else {
                const className = paragraph.hasIndent ? '' : 'no-indent-p';
                return `<p class="${className}">${content}</p>`;
            }
        }

        // 3. ãƒšãƒ¼ã‚¸å†ç”Ÿæˆç”¨ãƒ¡ã‚½ãƒƒãƒ‰
        regeneratePages() {
            // ç¾åœ¨ãƒšãƒ¼ã‚¸ã®startIdã‚’ä¿å­˜
            let restoreStartId = null;
            if (this.pageMeta && this.pageMeta.length > 0 && this.currentPageIndex < this.pageMeta.length) {
                restoreStartId = this.pageMeta[this.currentPageIndex]?.startId;
            }
            this.resetPagesAndState();
            this.setupMeasure();
            this.stepExecution();
            // ãƒšãƒ¼ã‚¸å†ç”Ÿæˆå¾Œã€startIdã§å¾©å…ƒ
            if (restoreStartId) {
                let foundIdx = 0;
                for (let i = 0; i < this.pageMeta.length; i++) {
                    if (this.pageMeta[i].startId === restoreStartId) {
                        foundIdx = i;
                        break;
                    }
                }
                this.currentPageIndex = foundIdx;
            } else {
                this.currentPageIndex = 0;
            }
            this.displayCurrentPage();
        }

                // reset()ã‚‚å…±é€šãƒªã‚»ãƒƒãƒˆã‚’åˆ©ç”¨
        reset() {
            this.resetPagesAndState();
            this.debugLog.innerHTML = '';
            this.log('ãƒªã‚»ãƒƒãƒˆå®Œäº†');
            this.setupMeasure();
            this.displayCurrentPage();
        }

        resetPagesAndState() {
            this.currentParagraphIndex = 0;
            this.currentParagraphContent = '';
            this.completedParagraphs = [];
            this.totalLineCount = 1;
            this.pages = [];
            this.currentPageIndex = 0;
            this.book.innerHTML = '';
            this._paragraphBuffer = null;
            this.currentParagraphHasIndent = true;
        }

        initEventListeners() {
            document.getElementById('step-btn').addEventListener('click', () => {
                this.stepExecution();
                this.displayCurrentPage();
            });

            document.getElementById('reset-btn').addEventListener('click', () => {
                this.reset();
            });

            document.getElementById('copy-log-btn').addEventListener('click', () => {
                this.copyLog();
            });

            document.getElementById('prev-page-btn').addEventListener('click', () => {
                this.prevPage();
            });

            document.getElementById('next-page-btn').addEventListener('click', () => {
                this.nextPage();
            });

            // ã‚¹ãƒ¯ã‚¤ãƒ—ã‚¤ãƒ™ãƒ³ãƒˆã‚‚åˆæœŸåŒ–æ™‚ã«è¨­å®š
            this.setupSwipeEvents();

            // â†“ã“ã“ã‹ã‚‰è¿½åŠ 
            const viewer = this.viewer;
            const bottomBar = document.getElementById('bottom-bar');
            const topBar = this.topBar;
            let barVisible = false;

            // ä¸­å¤®ä»˜è¿‘ã‚¿ãƒƒãƒ—ã§ä¸Šä¸‹ãƒãƒ¼è¡¨ç¤º/éè¡¨ç¤º
            viewer.addEventListener('click', (e) => {
                const rect = viewer.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                // ä¸­å¤®30%ã‚¨ãƒªã‚¢
                if (
                    x > rect.width * 0.35 && x < rect.width * 0.65 &&
                    y > rect.height * 0.35 && y < rect.height * 0.65
                ) {
                    barVisible = !barVisible;
                    bottomBar.classList.toggle('hidden', !barVisible);
                    topBar.classList.toggle('hidden', !barVisible);
                }
            });
            // ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚¯ãƒªãƒƒã‚¯ï¼ˆä»Šã¯ãƒ€ãƒŸãƒ¼ï¼‰
            document.getElementById('topbar-menu').addEventListener('click', () => {
                this.log('ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚¯ãƒªãƒƒã‚¯');
                // å¿…è¦ãªã‚‰ã“ã“ã§ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¡¨ç¤º
            });
            // ãƒ–ãƒ©ã‚¦ã‚¶ã‚¢ã‚¤ã‚³ãƒ³ã‚¯ãƒªãƒƒã‚¯ï¼ˆä»Šã¯ãƒ€ãƒŸãƒ¼ï¼‰
            document.getElementById('topbar-browser').addEventListener('click', () => {
                this.log('ãƒ–ãƒ©ã‚¦ã‚¶ã‚¢ã‚¤ã‚³ãƒ³ã‚¯ãƒªãƒƒã‚¯');
                // å¿…è¦ãªã‚‰ã“ã“ã§å¤–éƒ¨ãƒªãƒ³ã‚¯ç­‰
            });

            // æ–‡å­—ã‚µã‚¤ã‚ºå¤‰æ›´
            document.getElementById('font-bigger').addEventListener('click', () => {
                this.changeFontSize(1);
            });
            document.getElementById('font-smaller').addEventListener('click', () => {
                this.changeFontSize(-1);
            });

            // ãƒŠã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ï¼ˆè‰²ã¯å¾Œã§æŒ‡å®šï¼‰
            document.getElementById('toggle-night').addEventListener('click', () => {
                document.body.classList.toggle('night-mode');
            });

            document.getElementById('loadHtmlBtn').addEventListener('click', async () => {
                const fileInput = document.getElementById('fileInput');
                const file = fileInput.files[0];
                if (!file) {
                    this.log('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
                    return;
                }
                const text = await file.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(text, "text/html");
                const title = doc.querySelectorAll('h1.p-novel__title.p-novel__title--rensai');
                // ã‚¯ãƒ©ã‚¹ãŒä¸¡æ–¹ä¸€è‡´ã™ã‚‹divã‚’å–å¾—
                const targets = doc.querySelectorAll('div.js-novel-text.p-novel__text');
                this.log('div.js-novel-text.p-novel__text ã‚¿ã‚°ã‚’å–å¾—ã—ã¾ã—ãŸ: ' + targets.length + 'ä»¶');
                if (targets) {
                    // ãã®ç›´ä¸‹ã®è¦ç´ ã‚’source-contentã«ã‚»ãƒƒãƒˆ
                    this.source.innerHTML = '';

                    // ã‚¿ã‚¤ãƒˆãƒ«å–å¾—æ™‚ã‚‚å…¨è§’åŒ–
                    if (title.length > 0) {
                        title.forEach(t => {
                            this.log('ã‚¿ã‚¤ãƒˆãƒ«ã‚’å–å¾—ã—ã¾ã—ãŸ: ' + toZenkaku(t.textContent));
                            const titleElement = document.createElement('h2');
                            titleElement.className = t.className;
                            titleElement.textContent = toZenkaku(t.textContent);
                            this.source.appendChild(titleElement);
                        });
                    }

                    targets.forEach((target, idx) => {
                        // ç›´ä¸‹ã®å­è¦ç´ ã‚’source-contentã«è¿½åŠ 
                        Array.from(target.children).forEach(el => {
                            this.source.appendChild(el.cloneNode(true));
                        });
                        // ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚»ãƒ‘ãƒ¬ãƒ¼ã‚¿ã‚’æŒ¿å…¥ï¼ˆæœ€å¾Œã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ä»¥å¤–ï¼‰
                        if (idx < targets.length - 1) {
                            const hr = document.createElement('hr');
                            hr.className = 'section-separator';
                            this.source.appendChild(hr);
                        }
                    });
                    this.extractParagraphs();
                    this.regeneratePages();
                    this.currentPageIndex = 0;
                    this.displayCurrentPage();
                    this.log('å¤–éƒ¨HTMLèª­è¾¼æˆåŠŸ: div.js-novel-text.p-novel__text ã®ç›´ä¸‹è¦ç´ ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ');
                } else {
                    this.log('æŒ‡å®šã‚¿ã‚°(div.js-novel-text.p-novel__text)ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }
            });
        }

        loadEpisodeFromFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const content = e.target.result;
                this.source.innerHTML = content;
                this.extractParagraphs();
                this.reset();
                this.log('ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰èª­ã¿è¾¼ã¿å®Œäº†');
            };
            reader.onerror = (e) => {
                this.log('ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ' + e.target.error.message);
            };
            reader.readAsText(file);
        }

        // æ–‡å­—ã‚µã‚¤ã‚ºå¤‰æ›´ç”¨ãƒ¡ã‚½ãƒƒãƒ‰
        changeFontSize(delta) {
            const viewer = this.viewer;
            const style = window.getComputedStyle(viewer);
            let fontSize = parseFloat(style.fontSize) || 16;
            fontSize = Math.max(10, Math.min(36, fontSize + delta));
            viewer.style.fontSize = fontSize + 'px';
            this.log(`æ–‡å­—ã‚µã‚¤ã‚º: ${fontSize}px`);

            // ãƒšãƒ¼ã‚¸å†ç”Ÿæˆ
            this.regeneratePages();
            this.displayCurrentPage();
        }
    }

    window.addEventListener('load', () => { new LineCountDebug(); });
</script>
</body>
</html>